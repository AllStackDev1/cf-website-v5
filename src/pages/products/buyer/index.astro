---
import type { IAvailableCropOffers } from "types/app";

import Layouts from "@layouts/Layouts.astro";
import HeroContainer from "@components/products/HeroContainer.astro";

import {
  Hero,
  ExperienceCrop,
  CustomerStoriesSwiper,
  ProcurementTurnAround,
} from "@components/products/buyer";
import { AvailableCrops, Section } from "@components/utils";

import { getCropOffers } from "@utils/api";
import { convertToKebabCase } from "@utils/functions";
import { filterAt, getCategories, getCxStories } from "@utils/prismic";

const { results } = await getCategories("products");

const buyerId = results.find((c) => c.data.name === "Grower").id;

const filters = filterAt("my.customer_stories_v3.category", buyerId);

const customerStories = await getCxStories({
  page: 1,
  pageSize: 10,
  filters,
  fetchLinks: ["categories.name"],
});

const availableCropOffers: IAvailableCropOffers[] = [];

const response = await getCropOffers();

if (response) {
  const { statusCode, data } = response;
  if (statusCode == 200) {
    for (const c of data) {
      availableCropOffers.push({
        ...c,
        link: `/products/buyer/available-crops/${convertToKebabCase(
          c.crop.name
        )}`,
        specs: [
          c.specification?.cultivationType,
          c.specification?.condition,
          c.specification?.grade,
        ].join(", "),
      });
    }
  }
}
---

<Layouts
  title="Buyer | Complete Farmer"
  description="We are providing cutting-edge technological farming protocols and innovations with a unique business model and logistics that are revolutionizing..."
>
  <HeroContainer bgImage="bg-hero-buyer">
    <Hero client:load />
  </HeroContainer>
  <ProcurementTurnAround />
  <ExperienceCrop client:visible />
  {
    customerStories.results.length > 0 && (
      <CustomerStoriesSwiper data={customerStories} />
    )
  }
  {
    availableCropOffers.length > 0 && (
      <AvailableCrops
        cardType="buyer"
        bgColor="bg-buyer-200"
        data={availableCropOffers}
        titleTextColor="text-buyer-400"
        title="See what other farmers are growing"
      />
    )
  }
  <Section product="Buyer" client:visible />
</Layouts>

<!-- page: "/products/buyer", -->
<!-- <script>
  // @ts-nocheck
  import { $authModal } from "@utils/stores.ts";

  function toggleAuthModal() {
    $authModal.set(true);
    document.querySelector(".app-body").style.filter = "blur(4px)";
    document.querySelector(".app-footer").style.filter = "blur(4px)";
  }

  const btn = document.getElementById("get-started");

  btn.addEventListener("click", toggleAuthModal);
</script> -->
